
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>EQD spin to win</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=2.0">

    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="./styles/style.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="./library/jquery.slotmachine.css" type="text/css" media="screen" />

    <script defer src="https://use.fontawesome.com/releases/v5.0.10/js/all.js" integrity="sha384-slN8GvtUJGnv6ca26v8EzVaR9DC58QEwsIk9q1QXdCU8Yu8ck/tL/5szYlBbqmS+" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="./library/slotmachine.js"></script>
    <script src="./js/config.js"></script>
  </head>

  <body>
    <div id="slot">
        <div id="leftbar">
           <div id="instructions">
            <h1 class="upper">Instructions</h1>
              <div>
                <p>
                  <span class="upper">EQD spin to win</span> is a browser game where you spin the wheel to win EQD.
                </p>
                <hr class="styled" />
                <p>
                  <h3 class="subtitle">How to register an account?</h3>
                  To start playing the game you need to deposit EQD into the game wallet.<br />
                  To deposit use any Stellar wallet and send the EQD to <span class="walletAddr">GD472ON4HETV466W3WNQMAKDLAGVJBLKFXV4RNPPDAKPYW6FIM36QBQI</span><br />
                  It can take 5-10 minutes to register your wallet in the application and credit you with the funds you sent.
                </p>
                <hr class="styled" />
                <p>
                  <h3 class="subtitle">How to play?</h3>
                  After your account is created you can login to the application by using the public key from the wallet you sent the funds from.<br />
                  The fee per spin is <strong style="color:black">100 EQD</strong>. You can find the table with payouts beneath the instructions.<br />
                  After each spin your account will be credited with the result of that spin.<br />
                </p>
                  <hr class="styled" />
                <p>
                  <h3 class="subtitle">How to get a payout to your wallet?</h3>
                  You can request a payout to your wallet by using the <strong style="color:black">payout</strong> button on the slotmachine.<br />
                  Payouts can take 10 minutes depending on the number of users playing.
                </p>
                  <hr class="styled" />
                <p>
                  <h3 class="subtitle">Spin prices</h3>
                  The prices in the spinmachine are 
                 <span class="payoutEntry">0</span>,
                 <span class="payoutEntry">100</span>,
                 <span class="payoutEntry">500</span>,
                 <span class="payoutEntry">1000</span>,
                 <span class="payoutEntry">5000</span>.
                 <span class="payoutEntry">50000</span>.
               </p>
              <hr class="styled" />
                <p>
                  Good luck!
                </p>
              </div>
          </div>
           <div id="lastResults">
             <p>
                <h3 class="subtitle">
                  Playing as 
                </h3>
                <span id="loggedInAs"></span>
            </p>
            <hr class="styled" />
            <p>
              <h3 class="subtitle">Add credits</h3>
              To add more credits you can send more EQD from your wallet to the game wallet on<br />
              <span style="color:black" class="donate">GD472ON4HETV466W3WNQMAKDLAGVJBLKFXV4RNPPDAKPYW6FIM36QBQI</span><br />
              Incoming funds will be processed within 10 minutes.
            </p>
            <hr class="styled" />
            <p>
              <h3 class="subtitle">Winnings</h3>
                <p>
                  The winnings of your last 10 spins are shown here.
                </p>
              <table id="lastResultsTable">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Win</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td></td>
                    <td></td>
                </tbody>
              </table>
            </p>
         </div>
          <div id="contact">
            <h1 class="upper">Contact</h1>
            <p>
              If you have any questions or need support contact me on <a href="mailto:bas.moorkens@gmail.com">bas.moorkens@gmail.com</a><br />
            </p>
            <hr class="styled" />
            <p>
              Like the game? Consider dropping a Stellar donation to the dev on <span class="donate">GA7PSSZDIGORA7MK2QFNDLU3IYWIXOIPQU3NC7YHRWPSH43FFFZGVLG7</span>
            </p>
          </div>
      </div>
      <div id="container">
      <div id="login">
          <h1 class="upper">
            Login with your stellar public key
          </h1>
          <div id="loginDetail">
            <input type="text" id="publicKey" />
            <a href="#" id="loginButton">login</a>
          </div>
      </div>

      <div id="slotMachine">
        <div id="spinHeader">
            <h1>EQD Spin to win</h1>
        </div>
        <div id="spinnerBody">
            <div id="spinner">
                <div class="slotResult topLine">
                  0
                </div>
                <div class="slotResult topLine">
                  100
                </div>
                <div class="slotResult topLine">
                  500
                </div>
                <div class="slotResult topLine">
                  1000
                </div>
                <div class="slotResult topLine bottomLine">
                  5000
                </div>
                 <div class="slotResult topLine bottomLine">
                  50000
                </div>
              </div>
          </div>
          <div id="spinFooter">
            <div id="credits">
              Credits
              <span id="creditsValue">
                0
              </span>
            </div>
            <div id="betAmount">
              Bet
              <span id="betAmountValue">
                
              </span>
            </div>
            <div id="lastResult">
              Last result
              <span id="lastResultValue">

              </span>
            </div>
            <div id="payoutBuyttonContainer">
              <button id="payoutButton">Payout</button>
            </div>
            <div id="spinButtonContainer">
              <button id="spinButton">Spin</button>
            </div>
          </div>
      </div>
    </div>
    </div>

    <div id="payoutDialog" title="Request payout">
        <h1 class="upper">Payouts</h1>
        <p>
          Fill in the amount you want to get paid out in the box below.<br />
          <input type="text" id="amountToPay" style="width:100%"/>
          <div id="doPayoutButtonContainer">
              <a href="#" id="doPayoutButton">Payout</a>
            </div>
        </p>
    </div>
<script id="codeScript4">
const loginButton = document.querySelector('#loginButton');
const spinButton = document.querySelector('#spinButton');
const elTriky = document.querySelector('#spinner');
var playerWalletInfo;
var lastWinning=0;
var spinResult=0;
const slotMachine = new SlotMachine(elTriky, {
  randomize() {
    return spinResult;
  },
  onComplete() {
      updateDynamicPlayerWalletInfo();
      addResultToTable();
      document.getElementById("spinButton").disabled = false;
  }
});

var newResult;

$( "#payoutDialog" ).dialog({
      autoOpen: false,
      modal: true,
      width: 600,
      height: 350,
      show: {
        effect: "blind",
        duration: 1000
      },
      hide: {
        effect: "explode",
        duration: 1000
      }
    });
 
 $( "#doPayoutButton" ).on( "click", function() {
      var amount = $("#amountToPay").val();
      if(isNaN(amount)){
        alert("Amount to withdraw must be a number!");
      } else {
        if(amount <= 0) {
          alert("Amount must be greater then 0!");
        } else {
          $.post(applicationConfiguration.backendUrl +"payout", {publicKey: playerWalletInfo.publicKey, amount: amount}, function(response){
            alert("We have received your payout request for " + amount + "EQD. Payouts can take up to 10 minutes.");
            playerWalletInfo.amount = playerWalletInfo.amount - amount;
            renderPlayerWalletInfo();
            $("#payoutDialog").dialog("close");
            $("#amountToPay").val(0);
          }).fail(function(response) {
            if(typeof response.responseText == 'undefined') {
              alert('Spinmachine backend unavailable. Could not submit payout request.');
            } else {
              var jsonResponse = JSON.parse(response.responseText);
              alert('Error during payout request: ' + jsonResponse.message)
            }
          });
        }
      }
    });

    $( "#payoutButton" ).on( "click", function() {
      $( "#payoutDialog" ).dialog( "open" );
    });

function getSpinResult () {
   $.post(applicationConfiguration.backendUrl +"playslots", {publicKey: playerWalletInfo.publicKey}, function(response){
      playerWalletInfo.amount = response.balance;
      lastWinning = response.winning;
      spinResult = response.spinFollowNumber;
      newResult = {"wonTime":response.spinDateTime,"amount": response.winning};
    }).fail(function(response) {
      if(typeof response.responseText == 'undefined') {
        alert('Spinmachine backend unavailable. No spin was deducted from your balance.');
      } else {
        var jsonResponse = JSON.parse(response.responseText);
        alert('Error when spinning: ' + jsonResponse.message)
      }
    });
}

function addResultToTable() {
  if($('#lastResultsTable tr').length > 10) {
      $('#lastResultsTable tr:last').remove();
  }
  $("<tr><td>"+ newResult.wonTime+"</td><td>"+ newResult.amount +"</td></tr>").insertBefore("#lastResultsTable > tbody > tr:first");
}

function updateDynamicPlayerWalletInfo() { 
    $("#creditsValue").text(playerWalletInfo.amount);
    $("#lastResultValue").text(lastWinning);
}

function renderPlayerWalletInfo() {
  if(playerWalletInfo != null) {
    $("#login").hide(100);
    $("#instructions").hide(100);
    $("#loggedInAs").text(playerWalletInfo.publicKey.substring(0,15)+ "..." + playerWalletInfo.publicKey.substring(41,56));
    $("#slotMachine").css('visibility', 'visible');
    $("#lastResults").show(100);
    updateDynamicPlayerWalletInfo();
  }
}

function renderFullPlayerWalletInfo () {
  renderPlayerWalletInfo();
  renderLastResults();
}

function renderLastResults() {
  if( playerWalletInfo.lastWinnings != null ) {
    for (var i = 0; i < playerWalletInfo.lastWinnings.length; i++) {
      var lastResult = playerWalletInfo.lastWinnings[i];
      $("#lastResultsTable tbody").append("<tr><td>"+ lastResult.wonTime+"</td><td>"+ lastResult.amount +"</td></tr>");
    }
  }
  $("#lastResults").show(1000);
}

$( document ).ready(function() {
  $("#betAmountValue").text(applicationConfiguration.betAmount);
  spinButton.addEventListener('click', function () { 
    document.getElementById("spinButton").disabled = true;
    getSpinResult();
    slotMachine.shuffle(8); 
  });
  loginButton.addEventListener('click', function() {
    var publicKeyInput = document.getElementById("publicKey");
    $.post(applicationConfiguration.backendUrl + "loginPublicKey", {publicKey: publicKeyInput.value}, function(response){
      playerWalletInfo = response;
      renderFullPlayerWalletInfo();
    }).fail(function(xhr) {
        if(xhr.responseJSON != null) {
          alert('Error logging in: ' + xhr.responseJSON.message );
        } else {
          alert('Spin to win backend unavailable');
        }
    });
  });   
});

</script>

  </body>
</html>
