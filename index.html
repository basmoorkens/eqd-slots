
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>EQD spin to win</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=2.0">

    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"></script>
    <link rel="stylesheet" href="./styles/style.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="./library/jQuery-SlotMachine/jquery.slotmachine.css" type="text/css" media="screen" />

    <script defer src="https://use.fontawesome.com/releases/v5.0.10/js/all.js" integrity="sha384-slN8GvtUJGnv6ca26v8EzVaR9DC58QEwsIk9q1QXdCU8Yu8ck/tL/5szYlBbqmS+" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="./library/jQuery-SlotMachine/slotmachine.js"></script>
    <script src="./library/jQuery-SlotMachine/jquery.slotmachine.js"></script>
  </head>

  <body>
    <div id="slot">
      <div class="container">
      <div id="login">
          <h1>
            Login with your stellar public key
          </h1>
          <div id="loginDetail">
            <input type="text" id="publicKey" size="70" />
            <a href="#" id="loginButton">login</a>
          </div>
      </div>
      <div id="loggedIn">
          <h1>
            Playing as 
          </h1>
          <span id="loggedInAs"></span>
      </div>

      <div id="slotMachine">
        <div id="spinHeader">
            <h1>EQD Spin to win</h1>
        </div>
        <div id="spinnerBody">
            <div id="spinner">
                <div class="slotResult topLine">
                  10
                </div>
                <div class="slotResult topLine">
                  100
                </div>
                <div class="slotResult topLine">
                  500
                </div>
                <div class="slotResult topLine">
                  1000
                </div>
                <div class="slotResult topLine bottomLine">
                  5000
                </div>
              </div>
          </div>
          <div id="spinFooter">
            <div id="credits">
              Credits
              <span id="creditsValue">
                0
              </span>
            </div>
            <div id="betAmount">
              Bet
              <span id="betAmountValue">
                
              </span>
            </div>
            <div id="lastResult">
              Last result
              <span id="lastResultValue">
                100
              </span>
            </div>
            <div id="spinButtonContainer">
              <a href="#" id="spinButton">Spin</a>
            </div>
          </div>
      </div>
    </div>

    <div id="lastResults">
      <table id="lastResultsTable">
        <tr>
          <th>Time</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Hash</th>
        </tr>
      </table>
    </div>
    </div>
<script id="codeScript4">
const betAmount = 100;
const loginButton = document.querySelector('#loginButton');
const spinButton = document.querySelector('#spinButton');
const elTriky = document.querySelector('#spinner');
var playerWalletInfo;
var lastWinning;
const slotMachine = new SlotMachine(elTriky, {
  randomize() {
    return getSpinResult();
  }
});

function getSpinResult () {
   $.post("http://localhost:8080/playslots", {publicKey: playerWalletInfo.publicKey}, function(response){
      playerWalletInfo.amount -= 100;
      lastWinning = response.amount;
      updateDynamicPlayerWalletInfo();
      return response.followNumber;
    }).fail(function(response) {
      var jsonResponse = JSON.parse(response.responseText);
      alert('Error when spinning: ' + jsonResponse.message)
    });
}

function updateDynamicPlayerWalletInfo() { 
    $("#creditsValue").text(playerWalletInfo.amount);
}

function renderPlayerWalletInfo() {
  if(playerWalletInfo != null) {
    $("#login").hide(1000);
    $("#loggedIn").show(0);
    $("#loggedInAs").text(playerWalletInfo.publicKey);
    $("#slotMachine").css('visibility', 'visible');
    $("#lastResults").show(0);
    updateDynamicPlayerWalletInfo();
    renderLastResults();
  }
}

function renderLastResults() {
  for (var i = 0; i < playerWalletInfo.lastResults.length; i++) {
    var lastResult = playerWalletInfo.lastResults[i];
    $("#lastResultsTable tbody").append("<tr><td>"+ lastResult.wonTime+"</td><td>"+ lastResult.amount +"</td><td>"+ lastResult.status +"</td><td>"+ lastResult.blockchainHash +"</td></tr>");
  }
}

$( document ).ready(function() {
  $("#betAmountValue").text(betAmount);
  spinButton.addEventListener('click', () => slotMachine.shuffle(5));
  loginButton.addEventListener('click', function() {
    var publicKeyInput = document.getElementById("publicKey");
    $.post("http://localhost:8080/loginPublicKey", {publicKey: publicKeyInput.value}, function(response){
      playerWalletInfo = response;
      renderPlayerWalletInfo();
    }).fail(function(response) {
      if ($.trim(response)){ 
          alert('Spin to win backend unavailable');
      } else {
          var jsonResponse = JSON.parse(response.responseText);
          alert('Error logging in: ' + jsonResponse.message)
      }
    });
  });   
});

</script>


  </body>
</html>
